---
title: '@pytest.fixture ã§å‰å‡¦ç†ã€å¾Œå‡¦ç†ã«å¼•æ•°ã‚’æ¸¡ã™'
emoji: 'ğŸ™Œ'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [pytest, scope]
published: true
---

ã™ã¿ã¾ã›ã‚“ã€å°‘ã—é•·ããªã£ãŸã®ã§ã€Œå‰å‡¦ç†ï¼†å¾Œå‡¦ç†ï¼†å¼•æ•°ã‚’æ¸¡ã™ã€ã«ã¤ã„ã¦ã ã‘ã€è¦‹ãŸã„å ´åˆã€Œå¾Œå‡¦ç†ã§ã‚‚å¼•æ•°ã‚’ä½¿ã„ãŸã„å ´åˆã€ã®ç®‡æ‰€ã«é£›ã‚“ã§ãã ã•ã„ã€‚

## å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å‰ã«å…±é€šã®å‡¦ç†ã‚’ã—ãŸã„

ãã‚“ãªã¨ãã« pytest ã§å½¹ç«‹ã¤ã®ã¯ã”å­˜çŸ¥ fixture

```python
@pytest.fixture
def setup():
    # ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ãªã©
    table = Table()
    return table

class TestClass:
    def test_code_1(self, setup):
        test_data = "test_data"
        expected = "test_data"
        assert test_data == expected # ãªã‚“ã˜ã‚ƒã“ã®ãƒ†ã‚¹ãƒˆã¯setupã„ã‚‰ã‚“ã‚„ã‚“ã‘
```

ã“ã‚“ãªå½¢ã§ã€å…±é€šåŒ–ã—ãŸã„å‰å‡¦ç†ã‚’å®šç¾©ã—ãŸé–¢æ•° `setup` ã« `@pytest.fixture` ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã—ã¦ä½¿ã†ã€‚
ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•° `test_code_1` ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å¼•æ•°ã«è¿½åŠ ã™ã‚‹ã ã‘ã§ãƒ†ã‚¹ãƒˆã®å‡¦ç†ã«å…¥ã‚‹å‰ã« `setup` ã®å†…å®¹ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã‚‹ã€‚

ã¡ãªã¿ã«ã€`@pytest.fixture(autouse=True)` ã¨ã™ã‚Œã°ã€ `test_code_1()` ã®å¼•æ•°ã«ã€ `setup` ã‚’æ¸¡ã•ãªãã¦ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

```python
@pytest.fixture(autouse=True)
def setup():
    ...

class TestClass:
    def test_code_1(self):
    ...

```

## å‰å‡¦ç†ã«åŠ ãˆã¦ã€å¾Œå‡¦ç†ã‚‚å…±é€šåŒ–ã—ãŸã„

ã¨ãªã£ãŸã‚‰

```python
@pytest.fixture
def setup():
    # å‰å‡¦ç†
    print("ãƒ†ã‚¹ãƒˆã¯ã˜ã‚ã‚‹ã‚ˆ")

    yield # return -> yield (æˆ»ã‚Šå€¤ãŒã‚ã‚Œã° yield somethingï¼‰

    # å¾Œå‡¦ç†
    print("ãƒ†ã‚¹ãƒˆãŠã‚ã£ãŸã‚ˆ")

class TestClass:
    def test_code_1(self, setup):
        test_data = "test_code_1"
        expected = "test_code_1"

        print("test_code_1")
        assert test_data == expected

    def test_code_2(self, setup):
        test_data = "test_code_2"
        expected = "test_code_2"

        print("test_code_2")
        assert test_data == expected
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€

```å®Ÿè¡Œçµæœ
ãƒ†ã‚¹ãƒˆã¯ã˜ã‚ã‚‹ã‚ˆ
test_code_1
ãƒ†ã‚¹ãƒˆãŠã‚ã£ãŸã‚ˆ
ãƒ†ã‚¹ãƒˆã¯ã˜ã‚ã‚‹ã‚ˆ
test_code_2
ãƒ†ã‚¹ãƒˆãŠã‚ã£ãŸã‚ˆ
```

ã¨ã€å„ãƒ†ã‚¹ãƒˆã®å‰ã«ã€€`setup`ã®`yield` ã‚ˆã‚Šå‰ã®éƒ¨åˆ†ã€

å„ãƒ†ã‚¹ãƒˆã®å¾Œã«ã€€`setup`ã®`yield` ã‚ˆã‚Šå¾Œã®éƒ¨åˆ†ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã‚‹ã€‚

## setup() ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å¤‰ãˆã‚‹ã«ã¯ï¼ˆé–¢æ•°æ¯ã˜ã‚ƒãªãã¦ã€ãƒ†ã‚¹ãƒˆå…¨ä½“ã§ä¸€å›ã¨ã‹ï¼‰

1 ã¤å‰ã®ã‚³ãƒ¼ãƒ‰ã¯ã€setup å†…ã®å‡¦ç†ãŒã€å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ¯ã«å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ãŒã€ãã‚Œã¯`@pytest.fixture`ã«æ¸¡ã›ã‚‹`scope`ã¨ã„ã†å¼•æ•°ã‚’æŒ‡å®šã—ã¦ã„ãªã„ã‹ã‚‰ã€‚

| scope    | å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°    | default |
| -------- | ----------------- | ------- |
| function | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ¯    | â—‹       |
| class    | ã‚¯ãƒ©ã‚¹æ¯          |         |
| module   | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ¯  |         |
| session  | ãƒ†ã‚¹ãƒˆå…¨ä½“ã§ 1 å› |         |

ä¸Šè¨˜ãŒ`scope`ã§æŒ‡å®šã§ãã‚‹å€¤ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ function ã®ãŸã‚ã€æŒ‡å®šã—ãªã„å ´åˆã¯ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ¯ã«å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

ã¨ã“ã“ã¾ã§ã‚¿ã‚¤ãƒˆãƒ«ã®ã€ã€Œå¼•æ•°ã‚’æ¸¡ã™æ–¹æ³•ã€ã‹ã‚‰ã„ãã‚‰ã‹è„±ç·šã—ã¦ããŸæ°—ã‚‚ã—ã¾ã™ãŒã€ã‚ˆã†ã‚„ãæœ¬é¡Œã«å…¥ã‚Šã¾ã™ã€‚

## setup() ã«å¼•æ•°ã‚’æ¸¡ã™ã«ã¯

ã¾ãšã€`@pytest.fixture`ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã—ãŸé–¢æ•°ã«å¼•æ•°ã‚’æ¸¡ã™æ–¹æ³•ã¯ã“ã‚“ãªå½¢ã§ã™ã€‚

```python
@pytest.fixture
def setup():
  def _setup(arg):
    # å‰å‡¦ç†
    return arg
  return _setup
```

`setup`ã®å…§éƒ¨ã«ã€`_setup`ã¨ã„ã†é–¢æ•°ã‚’å®šç¾©ã—ã¦ã€ãã®ä¸­ã§å‰å‡¦ç†ã‚’è¨˜è¿°ã—ã¾ã™ã€‚ãã—ã¦ã€å¤–å´ã®`setup` ã§ã¯`_setup`ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## setup() ã«å¼•æ•°ã‚’æ¸¡ã™

ä»Šã¾ã§ã•ã‚“ã–ã‚“ã€`@pytest.fixture`ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã—ã¦å‰å‡¦ç†ã€å‰å‡¦ç†è¨€ã£ã¦ãã¾ã—ãŸãŒã€å‰å‡¦ç†ã«é™ã‚‰ãšå…±é€šåŒ–ã—ãŸã„ã“ã¨ã«ä½¿ãˆã‚‹ã®ã§ã€ä¾‹ãˆã°å¼•æ•°ã®æ•°å­—ã‚’ã‚½ãƒ¼ãƒˆã™ã‚‹é–¢æ•°ã«`@pytest.fixture`ã‚’ã¤ã‘ã¦ã€å¼•æ•°ã‚’æ¸¡ã™ä¾‹ã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚

```python

@pytest.fixture
def sort_desc():
  def _sort_desc(arg1, arg2, arg3):
    return sorted([arg1, arg2, arg3], reverse=True)
  return _sort_desc

class TestClass:
  def test_code_1(self, sort_desc):
    test_data = sort_desc(1, 2, 3)
    expected = [3, 2, 1]
    assert test_data == expected

  def test_code_2(self, sort_desc):
    test_data = sort_desc(-1, 3, 100)
    expected = [100, 3, -1]
    assert test_data == expected
```

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‹ã‚‰å‘¼ã³å‡ºã™ã¨ãã«ã¯ã€`_sort_desc` ã§ã¯ãªãã€`sort_desc`ã‚’å‘¼ã³å‡ºã›ã°è‰¯ã„ã§ã™ã€‚

## å‰å‡¦ç†ï¼†å¾Œå‡¦ç†ï¼†å¼•æ•°ã‚’æ¸¡ã™

æœ¬å½“ã«æœ€å¾Œã«ã€å…±é€šã®å‰å‡¦ç†ã€å¾Œå‡¦ç†ã‚’ã—ãŸã„ã€ãã—ã¦å¼•æ•°ã‚’æ¸¡ã—ãŸã„å ´åˆã«ã¤ã„ã¦ã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚

å…ˆç¨‹å‡ºã¦ããŸã‚¯ã‚½ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å†æ²

```python
@pytest.fixture
def setup():
    # å‰å‡¦ç†
    print("ãƒ†ã‚¹ãƒˆã¯ã˜ã‚ã‚‹ã‚ˆ")

    yield # return -> yield (æˆ»ã‚Šå€¤ãŒã‚ã‚Œã° yield somethingï¼‰

    # å¾Œå‡¦ç†
    print("ãƒ†ã‚¹ãƒˆãŠã‚ã£ãŸã‚ˆ")

class TestClass:
    def test_code_1(self, setup):
        test_data = "test_code_1"
        expected = "test_code_1"

        print("test_code_1")
        assert test_data == expected

    def test_code_2(self, setup):
        test_data = "test_code_2"
        expected = "test_code_2"

        print("test_code_2")
        assert test_data == expected

```

å‰å‡¦ç†ã§â€ãƒ†ã‚¹ãƒˆã¯ã˜ã‚ã‚‹ã‚ˆâ€ã¨å‡ºåŠ›ã—ã¦ã„ã‚‹ã®ã§ã€å¼•æ•°ã‚’æ¸¡ã—ã¦ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹åã‚‚å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```python
@pytest.fixture
def setup():
    # å…§éƒ¨ã«å¼•æ•°ã‚’æŒã¤é–¢æ•°ã‚’è¿½åŠ 

    def _setup(arg):
        # å‰å‡¦ç†
        print(f"ãƒ†ã‚¹ãƒˆã¯ã˜ã‚ã‚‹ã‚ˆ testå: {arg}")
        return

    yield _setup

    # å¾Œå‡¦ç†
    print("ãƒ†ã‚¹ãƒˆãŠã‚ã£ãŸã‚ˆ")


class TestClass:
    def test_code_1(self, setup):
        setup("test_code_1")

        test_data = "test_code_1"
        expected = "test_code_1"

        assert test_data == expected

    def test_code_2(self, setup):
        setup("test_code_2")

        test_data = "test_code_2"
        expected = "test_code_2"

        assert test_data == expected
```

ã“ã‚Œã§ã€ä»Šä½•ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ã‚ã‹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã‚ã§ãŸã—ã‚ã§ãŸã—

## å¾Œå‡¦ç†ã§ã‚‚å¼•æ•°ã‚’ä½¿ã„ãŸã„å ´åˆ

å¾Œå‡¦ç†ã§ã‚‚å¼•æ•°ã‚’ä½¿ã„ãŸã„å ´åˆã¯

```python
@pytest.fixture
def setup():

    args = [] # å¾Œå‡¦ç†ã§ä½¿ã†å¼•æ•°ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆ

    def _setup(arg1):
        # å‰å‡¦ç†
        args.append(arg1) # å¼•æ•°ã‚’ãƒªã‚¹ãƒˆã«æ ¼ç´
        print(f"ãƒ†ã‚¹ãƒˆã¯ã˜ã‚ã‚‹ã‚ˆ testå: {arg1}")
        return

    yield _setup

    # å¾Œå‡¦ç†
    for arg in args:
        print(f"ãƒ†ã‚¹ãƒˆãŠã‚ã£ãŸã‚ˆ testå: {arg}")
```

ã‚‚ã£ã¨è‰¯ã„æ–¹æ³•ãŒã‚ã‚Šãã†ã§ã™ãŒã€ã¨ã‚Šã‚ãˆãšã“ã‚Œã§å®Ÿç¾ã§ãã‚‹ã¯ãšã§ã™ã€‚

## ã¾ã¨ã‚

ä»Šæ›´ãªãŒã‚‰ã€å¾Œå‡¦ç†ã‚‚ã™ã‚‹ã®ã«é–¢æ•°åãŒ`setup`ã£ã¦ã„ã‘ã¦ãªã„ã§ã™ã‚ˆã­ã€‚
ãã—ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒç·ã˜ã¦ã²ã©ãã¦ç”³ã—è¨³ãªã„ã§ã™ã€‚ãŒæŠ½è±¡åŒ–ã—ã¦ã€`scope`ã‚‚ã†ã¾ãæ´»ç”¨ã—ã¦ã‚„ã£ã¦é ‚ã‘ãŸã‚‰å¹¸ã„ã§ã™ã€‚
ãã—ã¦ã€å›°ã£ãŸã‚‰ï¼ˆã„ã‚„æœ€åˆã‹ã‚‰ï¼‰å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚“ã§ãã ã•ã„ã€‚
https://docs.pytest.org/en/7.1.x/how-to/fixtures.html
èª­ã‚“ã§ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
